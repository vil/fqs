#!/usr/bin/env bash
# |---------------------------------------|
# | Copyright (c) 2024-2025 Vili. GPL-3.0 |
# |---------------------------------------|
#        Made in Finland, with love.

set -euo pipefail
IFS=$'\n\t'

# Check if a command exists
command_exists() {
    command -v "$1" &>/dev/null
}

# Performs a full system upgrade.
sys_update() {
    sudo dnf upgrade --refresh -y
}

# Adds and enables the RPM Fusion repositories.
add_rpm_repos() {
    local fedora_ver
    fedora_ver="$(rpm -E %fedora)"
    sudo dnf install -y "https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-${fedora_ver}.noarch.rpm" \
                         "https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-${fedora_ver}.noarch.rpm"
    sudo dnf install -y dnf-plugins-core
    sudo dnf group upgrade core -y
}

# Adds and enables the Flathub remote.
add_flatpak_repos() {
    if ! command_exists flatpak; then
        echo "Flatpak not found. Installing flatpak..."
        sudo dnf install flatpak -y
    fi
    flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
}

# Appends performance-friendly options to /etc/dnf/dnf.conf.
append_dnf_configs() {
    local conf_file="/etc/dnf/dnf.conf"
    sudo tee -a "$conf_file" >/dev/null <<'EOF'
gpgcheck=1
clean_requirements_on_remove=True
skip_if_unavailable=True
deltarpm=False
best=False
keepcache=True
installonly_limit=3
max_parallel_downloads=10
defaultyes=True
EOF
    sudo dnf upgrade --refresh -y
}

# Setup automatic updates (DNF-automatic).
setup_auto_updates() {
    sudo dnf install -y dnf-automatic

    # check if config file exists
    local conf_file="/etc/dnf/automatic.conf"
    if [ ! -f "$conf_file" ]; then
        sudo touch "$conf_file"
        # append config
        sudo tee -a "$conf_file" >/dev/null <<'EOF'
[commands]
upgrade_type = security
random_sleep = 0
download_updates = yes
apply_updates = yes

[emitters]
emit_via = stdio

EOF
    fi

    sudo systemctl enable --now dnf-automatic.timer
}

# Hardening
sys_hardening() {
    # Install usbguard
    echo Installing usbguard for USB device control...
    sudo dnf install -y usbguard usbguard-notifier
    # Generate config for current hardware
    sudo usbguard generate-policy | sudo tee /etc/usbguard/rules.conf >/dev/null
    # Enable and start the service
    sudo systemctl enable --now usbguard

    # Enable MAC address randomization for Wi-Fi
    echo Enabling MAC address randomization for Wi-Fi...
    local network_file="/etc/NetworkManager/conf.d/00-macrandomize.conf"
    if [ ! -f "$network_file" ]; then
        sudo touch "$network_file"
    fi
    if ! grep -q "wifi.scan-rand-mac-address=yes" "$network_file"; then
        sudo tee -a "$network_file" >/dev/null <<'EOF'
[device]
wifi.scan-rand-mac-address=yes

[connection]
wifi.cloned-mac-address=random
ethernet.cloned-mac-address=random
EOF
        sudo systemctl restart NetworkManager
    fi

    # Some sysctl hardening settings
    echo Applying sysctl hardening settings...
    local sysctl_file="/etc/sysctl.d/99-hardening.conf"

    if [ ! -f "$sysctl_file" ]; then
        sudo touch "$sysctl_file"
    fi
    sudo tee -a "$sysctl_file" >/dev/null <<'EOF'
# Disable IP forwarding
net.ipv4.ip_forward = 0
# Kernel VA Space Protection
kernel.randomize_va_space = 2
# Ignore ICMP broadcast requests
net.ipv4.icmp_echo_ignore_broadcasts = 1
# SUID Dumpable disabled
fs.suid_dumpable = 0
EOF
    sudo sysctl --system
}

# Enroll and setup secure boot
enroll_secureboot() {
    # Installing sbctl
    sudo dnf copr enable chenxiaolong/sbctl
    sudo dnf upgrade --refresh -y
    sudo dnf install sbctl -y

    # Enroll and create keys
    echo "Creating keys..."
    sudo sbctl create-keys
    echo "Enrolling keys..."
    sudo sbctl enroll-keys -m
}

# VPN App installation
install_vpn_app() {
    echo "Choose your preferred VPN app:"
    echo "  1. IVPN (https://ivpn.net/)"
    echo "  2. Mullvad (https://mullvad.net/)"
    read -r -p "Enter the number of your preferred VPN app: " choice

    case "$choice" in
        1)
            sudo dnf config-manager addrepo --from-repofile=https://repo.ivpn.net/stable/fedora/generic/ivpn.repo
            sudo dnf upgrade --refresh -y
            sudo dnf install -y iptables-legacy ivpn-ui
            ;;
        2)
            sudo dnf config-manager addrepo --from-repofile=https://repository.mullvad.net/rpm/stable/mullvad.repo
            sudo dnf upgrade --refresh -y
            sudo dnf install -y mullvad-vpn
            ;;
        *)
            echo "Invalid choice. No VPN app installed."
            ;;
    esac
}

# Install the preferred code editor.
install_code_editor() {
    echo "Choose your preferred code editor:"
    echo "  1. Zed (https://zed.dev)"
    echo "  2. VSCodium (https://vscodium.com/)"
    echo "  3. NeoVim+NvChad (https://neovim.io/ with NvChad https://nvchad.com)"
    read -r -p "Enter the number of your preferred editor: " choice

    case "$choice" in
        1)
            curl -f https://zed.dev/install.sh | sh
            ;;
        2)
            sudo rpmkeys --import https://gitlab.com/paulcarroty/vscodium-deb-rpm-repo/-/raw/master/pub.gpg
            printf "[gitlab.com_paulcarroty_vscodium_repo]\nname=VSCodium Repository\nbaseurl=https://download.vscodium.com/rpms/\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=https://gitlab.com/paulcarroty/vscodium-deb-rpm-repo/-/raw/master/pub.gpg\nmetadata_expire=1h\n" | sudo tee /etc/yum.repos.d/vscodium.repo
            sudo dnf upgrade --refresh -y && sudo dnf install codium -y
            ;;
        3)
            sudo dnf upgrade --refresh -y && sudo dnf install neovim -y
            git clone https://github.com/NvChad/starter ~/.config/nvim
            echo "NvChad will be installed once you start NeoVim for the first time..!"
            ;;
        *)
            echo "Invalid choice. No editor installed."
            ;;
    esac
}

# Install Steam with Proton-GE
setup_protonge() {
    echo "Installing Steam..."
    sudo dnf install steam -y
    echo "Installing latest Proton-GE..."
    mkdir -p ~/.steam/root/compatibilitytools.d && curl -s https://api.github.com/repos/GloriousEggroll/proton-ge-custom/releases/latest | grep "browser_download_url.*tar.gz" | cut -d\" -f4 | xargs curl -L | tar -xz -C ~/.steam/root/compatibilitytools.d    
}

# Install the preferred browser.
install_browser() {
    echo "Choose your preferred browser:"
    echo "  1. Brave (https://brave.com/)"
    echo "  2. Librewolf (https://librewolf.net/)"
    echo "  3. Chromium (https://chromium.org/)"
    read -r -p "Enter the number of your preferred browser: " choice

    case "$choice" in
        1)
            curl -fsS https://dl.brave.com/install.sh | sh
            echo
            echo
            read -r -p "Now that you have Brave installed, do you want to debloat it as well? (Disable Tor, VPN, AI, Rewards.) (y/N) " debloat
            if [[ "$debloat" =~ ^[yY]$ ]]; then
                debloat_brave
            else
                echo "Skipping Brave debloat step."
            fi
            ;;
        2)
            curl -fsSL https://rpm.librewolf.net/librewolf-repo.repo | pkexec tee /etc/yum.repos.d/librewolf.repo >/dev/null
            sudo dnf upgrade --refresh -y && sudo dnf install librewolf -y
            ;;
        3)
            sudo dnf install chromium -y
            ;;
        *)
            echo "Invalid choice. Using default (Firefox)."
            ;;
    esac
}

# Brave debloating
debloat_brave() {
    echo "Creating policies..."
    sudo mkdir -p /etc/brave/policies/managed/
    local debloat_policies="/etc/brave/policies/managed/debloat.json"

    if [ ! -f "$debloat_policies" ]; then
        sudo touch "$debloat_policies"
    fi
    sudo tee -a "$debloat_policies" >/dev/null <<'EOF'
{
    "BraveRewardsDisabled": true,
    "BraveWalletDisabled": true,
    "BraveVPNDisabled": true,
    "BraveAIChatEnabled": false,
    "TorDisabled": true
}
EOF
}

# Install and setup winboat.app
install_winboat() {
    echo "Installing and setuping WinBoat, make sure you have virtualization enabled in your BIOS..."
    sudo dnf install docker docker-compose freerdp.x86_64 -y
    sudo groupadd docker
    sudo usermod -aG docker "$USER"
    echo -e "ip_tables\niptable_nat" | sudo tee /etc/modules-load.d/iptables.conf
    echo "Getting and installing the WinBoat RPM file..."
    curl -s https://api.github.com/repos/TibixDev/winboat/releases/latest | grep -oP '"browser_download_url": "\K[^"]*\.rpm' | head -1 | xargs curl -L -o /tmp/winboat.rpm
    sudo dnf install /tmp/winboat.rpm
}

# # Install communication apps.
# install_communication() {
#     echo "Choose your communication app(s) (enter numbers separated by spaces):"
#     echo "  1. Discord (https://discord.com/)"
#     echo "  2. Vesktop (https://vencord.dev/)"
#     echo "  3. Element Desktop (https://element.io/)"
#     echo "  4. Telegram Desktop (https://telegram.org/)"
#     echo "  5. Signal Desktop (https://signal.org/)"

#     # Temporarily set IFS to include spaces
#     local oldIFS=$IFS
#     IFS=' '
#     read -ra choices -p "Your choices: "
#     IFS=$oldIFS

#     for choice in "${choices[@]}"; do
#         case "$choice" in
#             1)
#                 sudo dnf install discord -y
#                 ;;
#             2)
#                 flatpak install -y flathub dev.vencord.Vesktop
#                 ;;
#             3)
#                 flatpak install -y flathub im.riot.Riot
#                 ;;
#             4)
#                 sudo dnf install telegram-desktop -y
#                 ;;
#             5)
#                 flatpak install -y flathub org.signal.Signal
#                 ;;
#             *)
#                 echo "Invalid choice: $choice"
#                 ;;
#         esac
#     done
# }

# Install useful developer tools.
add_dev_tools() {
    # sudo dnf groupinstall "Development Tools" "Development Libraries" -y
    sudo dnf install kernel-devel android-tools python3-pip python3-devel git nodejs nodejs-npm golang -y
}

# Detect Nvidia GPU and offer driver installation.
needs_nvidia() {
    if lspci | grep -qi NVIDIA; then
        read -r -p "Nvidia GPU detected. Install Nvidia drivers (akmod-nvidia)? (y/N) " resp
        if [[ "$resp" =~ ^[yY]$ ]]; then
            sudo dnf install akmod-nvidia -y
            echo "Nvidia drivers installed."
        else
            echo "Skipping Nvidia driver installation."
        fi
    else
        echo "No Nvidia GPU detected."
    fi
}

# Patch for Apple keyboards (hid_apple fn key).
hid_apple_patch() {
    local conf_file="/etc/modprobe.d/hid_apple.conf"
    if [ ! -f "$conf_file" ]; then
        sudo touch "$conf_file"
    fi
    echo "options hid_apple fnmode=0" | sudo tee -a "$conf_file"
    sudo modprobe -r hid_apple
    sudo modprobe hid_apple
}

# Add dracut flags to support bluetooth keyboard during LUKS decryption.
add_dracut_flags() {
    local flags_file="/etc/dracut.conf.d/flags.conf"
    if [ ! -f "$flags_file" ]; then
        sudo touch "$flags_file"
    fi
    echo 'hostonly="yes"' | sudo tee -a "$flags_file"
    echo 'add_dracutmodules+=" bluetooth "' | sudo tee -a "$flags_file"
    sudo dracut --regenerate-all --force --verbose
}

# Install Tor and enable its service.
install_tor() {
    sudo dnf install tor torbrowser-launcher -y
    sudo systemctl enable --now tor
}

# Install extra software by trying DNF first then Flatpak.
install_selection() {
    local oldIFS pkg
    # Save the current IFS and temporarily set it to a space for word splitting.
    oldIFS="$IFS"
    IFS=' '
    for pkg in "$@"; do
        if rpm -q "$pkg" &>/dev/null; then
            echo "$pkg is already installed."
        else
            echo "Attempting to install $pkg via DNF..."
            if sudo dnf install -y "$pkg"; then
                echo "Installed $pkg via DNF."
            else
                echo "DNF did not find $pkg. Trying Flatpak from flathub..."
                sleep 1
                if flatpak install -y flathub "$pkg"; then
                    echo "Installed $pkg via Flatpak."
                else
                    echo "Error: $pkg not found in DNF or Flatpak repositories."
                fi
            fi
        fi
    done
    IFS="$oldIFS"
}

# Install a custom bash prompt.
setup_bash_prompt() {
    tee -a "$HOME/.bashrc" >/dev/null <<'EOF'
# Vili's Bash prompt
PROMPT_COMMAND='PS1_CMD1=$(git branch --show-current 2>/dev/null)'
PS1='\[\e[2m\]\t\[\e[0m\] \w ${PS1_CMD1} \$ '
EOF
}

# Setup SSH-keys and .gitconfig
setup_config() {
    if ! command_exists git; then
        echo "Git is not installed... Installing it now."
        sudo dnf install git -y
    fi
    echo "Running ssh-keygen first... Please answer the following questions:"
    ssh-keygen
    read -r -p "Enter your name for Git: " name
    git config --global user.name "$name"
    read -r -p "Enter your e-mail for Git: " email
    git config --global user.email "$email"
}

# ======== Main =========
echo "FQS (Fedora Quick Start) Script"
echo "Finish your post-installation steps easily."
echo "By Vili (@vil)"
echo
echo "You will be prompted for sudo password as needed."
echo
echo "ALWAYS VERIFY THE SCRIPTS THAT YOU'RE RUNNING, INCLUDING THIS ONE, NEVER TRUST ANYONE ON THE INTERNET!"
echo

read -r -p "Do you want to continue with this script? (y/N) " input
if [[ "$input" =~ ^[yY]$ ]]; then
    echo "Starting system upgrade..."
    sleep 2
    sys_update
    echo "System upgrade complete."
    echo

    echo "Enabling RPM Fusion repositories..."
    sleep 2
    add_rpm_repos
    echo "RPM Fusion enabled."
    echo

    echo "Enabling Flathub repository..."
    sleep 2
    add_flatpak_repos
    echo "Flathub enabled."
    echo

    echo "Optimizing DNF configuration..."
    sleep 2
    append_dnf_configs
    echo "DNF configuration updated."
    echo

    echo "Checking for Nvidia GPU..."
    sleep 2
    needs_nvidia
    echo

    echo "Proceeding with user selections..."
    sleep 2

    read -r -p "Setup automatic updates (DNF-automatic)? (y/N) " auto_update
    if [[ "$auto_update" =~ ^[yY]$ ]]; then
        setup_auto_updates
        echo "Automatic updates enabled."
    else
        echo "Skipping automatic updates setup."
    fi
    echo

    read -r -p "Patch Bluetooth keyboard FN key (hid_apple)? (y/N) " patch_hid
    if [[ "$patch_hid" =~ ^[yY]$ ]]; then
        hid_apple_patch
        echo "hid_apple patch applied."
    else
        echo "Skipping hid_apple patch."
    fi
    echo

    read -r -p "Allow Bluetooth keyboard during decryption (regenerate initramfs)? (y/N) " patch_dracut
    if [[ "$patch_dracut" =~ ^[yY]$ ]]; then
        add_dracut_flags
        echo "Dracut flags added."
    else
        echo "Skipping dracut flags."
    fi
    echo

    read -r -p "Install a trusted VPN app? (y/N) " vpn_choice
    if [[ "$vpn_choice" =~ ^[yY]$ ]]; then
        install_vpn_app
        echo "VPN app installation complete."
    else
        echo "Skipping VPN app installation."
    fi
    echo

    read -r -p "Install an alternative browser (not Firefox)? (y/N) " browser_choice
    if [[ "$browser_choice" =~ ^[yY]$ ]]; then
        install_browser
        echo "Browser installation complete."
    else
        echo "Default browser (Firefox) will be used."
    fi
    echo

    read -r -p "Install Steam with latest Proton-GE? (y/N) " steam_choice
    if [[ "$steam_choice" =~ ^[yY]$ ]]; then
        setup_protonge
        echo "Steam with Proton-GE setup done."
    else
        echo "Skipping Steam & Proton-GE setup..."
    fi
    echo

    # read -r -p "Install communication apps? (y/N) " comm_choice
    # if [[ "$comm_choice" =~ ^[yY]$ ]]; then
    #     install_communication
    #     echo "Communication apps installed."
    # else
    #     echo "Skipping communication apps."
    # fi
    # echo

    read -r -p "Install a code editor? (y/N) " editor_choice
    if [[ "$editor_choice" =~ ^[yY]$ ]]; then
        install_code_editor
        echo "Code editor installation complete."
    else
        echo "Skipping code editor installation."
    fi
    echo

    read -r -p "Install developer tools (git, nodejs, etc.)? (y/N) " dev_choice
    if [[ "$dev_choice" =~ ^[yY]$ ]]; then
        add_dev_tools
        echo "Developer tools installed."
    else
        echo "Skipping developer tools."
    fi
    echo

    read -r -p "Generate SSH keys and Git config? (y/N) " config_choice
    if [[ "$config_choice" =~ ^[yY]$ ]]; then
        setup_config
        echo "Done."
    else
        echo "Skipping SSH keygen and Git config setup..."
    fi
    echo

    read -r -p "Install and setup WinBoat to run Windows apps with seamless integration? (y/N) " winboat_choice
    if [[ "$winboat_choice" =~ ^[yY]$ ]]; then
        install_winboat
        echo "WinBoat installed, reboot may be necessary after this script has done running!"
    else
        echo "Skipping WinBoat setup."
    fi
    echo

    read -r -p "Install Tor and enable Tor service? (y/N) " tor_choice
    if [[ "$tor_choice" =~ ^[yY]$ ]]; then
        install_tor
        echo "Tor installed and enabled."
    else
        echo "Skipping Tor installation."
    fi
    echo

    read -r -p "Install additional software packages (e.g. 'discord spotify gimp')? (y/N) " extra_choice
    if [[ "$extra_choice" =~ ^[yY]$ ]]; then
        read -r -p "Enter package names (space-separated): " pkg_list
        echo "Installing: $pkg_list"
        install_selection "$pkg_list"
        echo "Optional software installation complete."
        sleep 1
    else
        echo "Skipping optional software installation."
    fi
    echo

    read -r -p "Install my simple and clean Bash prompt: 'CLOCK WORKING_DIR GIT_BRANCH $ '? (y/N) " bash_prompt_choice
    if [[ "$bash_prompt_choice" =~ ^[yY]$ ]]; then
        echo "Applying the custom Bash prompt..."
        sleep 2
        setup_bash_prompt
        echo "Bash prompt set!"
    else
        echo "Skipping Bash prompt setup."
    fi
    echo

    read -r -p "Apply some system hardening (usbguard, sysctl settings, MAC randomization)? (y/N) " harden_choice
    if [[ "$harden_choice" =~ ^[yY]$ ]]; then
        echo "Applying system hardening..."
        sleep 2
        sys_hardening
        echo "System hardening applied."
    else
        echo "Skipping system hardening."
    fi

    read -r -p "Enable and enroll Secure Boot? (y/N) " enroll_sb
    if [[ "$enroll_sb" =~ ^[yY]$ ]]; then
        echo "Enabling and enrolling Secure Boot keys..."
        sleep 2
        enroll_secureboot
        echo "Done, restart your system to apply and verify the keys by running 'sbctl status'..!"
    else
        echo "Skipping Secure Boot setup..."
    fi

    echo "All steps complete, remember to star this on GitHub. Goodbye!"
else
    echo "Script cancelled. Goodbye!"
fi
